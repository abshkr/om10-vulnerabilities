<?xml version="1.0" encoding="utf-8"?>
<s:Panel xmlns:fx="http://ns.adobe.com/mxml/2009" 
		 xmlns:s="library://ns.adobe.com/flex/spark" 
		 xmlns:mx="library://ns.adobe.com/flex/mx" 
		 skinClass="skins.PanelSkin" currentState="icon" useHandCursor="true" buttonMode="true" click="panel1_clickHandler(event)" >
	<s:states>
		<s:State name="icon"/>
		<s:State name="widget"/>
	</s:states>
	<fx:Script>
		<![CDATA[
			import events.ArrEvent;
			
			import mx.controls.Alert;
			import mx.core.FlexGlobals;
			import mx.core.IVisualElement;
			import mx.events.CloseEvent;
			import mx.events.FlexEvent;
			import mx.events.ModuleEvent;
			import mx.managers.PopUpManager;
			import mx.resources.ResourceManager;
			
			[Bindable] public var module:String;
			[Bindable] private var _info:Object;
			[Bindable] public var menu_ico:Class;

			public var cgiURL:String="null";
			
			public var iChild:*;
			
			private var chkPass:PasswordCheckDlg = new PasswordCheckDlg();
					
			public function set info(info:Object):void{
				_info = info;
				if(info.title == "m_monthend"){
					currentState = "widget";
				}else{
					currentState = "icon";
				}
			}
			public function get info():Object{
				return _info;
			}
			 protected function moduleloader1_readyHandler(event:ModuleEvent):void
			{
				iChild = ldr.child as IModuleInterface;
				if (iChild != null)
				{
					iChild.setCallback(showWindow);
				}
				if (info.title=="m_monthend")
					global.specialUpdate=(info.priv_update);
			} 
			
			public function showWindow(): void
			{
				if (info.priv_password == true)
				{
					trace("WTH");
					PopUpManager.addPopUp(chkPass,FlexGlobals.topLevelApplication.main,true);
					PopUpManager.centerPopUp(chkPass);
					chkPass.canceled=false;
					chkPass.userPassword.text="";
					chkPass.title=mx.resources.ResourceManager.getInstance().getString('default','CONFIRM_PASSWORD');
					chkPass.addEventListener(CloseEvent.CLOSE,onWinClose);
				}
				else
				{
					allowView();
				}
				trace( "..........showWindow is called......................", info.title );
			}
			
			private function allowView():void
			{
				// special popup for BayView and TankView
				if ( info.title == "m_bayview" || info.title == "m_tankview" )
				{
					var file_url:String;
					
					if ( info.title == "m_bayview" )
					{
						//file_url = "/bootstrap/BayView.php";
						file_url = "/scadaviews/bayview/index.html";
					}
					if ( info.title == "m_tankview" )
					{
						//file_url = "/bootstrap/TankView.php";
						file_url = "/scadaviews/tankview/index.html";
					}
					trace ( file_url );
					navigateToURL( new URLRequest( file_url ), '_blank' );
					return;
				}
				
				if(info.title!="m_monthend")
				{
					var arr:Array = new Array(title, module,info);
					dispatchEvent(new ArrEvent('menu',true,false,arr));
				}
			}
			
			protected function onWinClose(event:CloseEvent):void
			{
				if (!chkPass.canceled)
				{
					if (chkPass.userPassword.text == global.userpass) 
					{
						allowView();
					}
					else
					{
						global.msgFail(mx.resources.ResourceManager.getInstance().getString('default','FAIL_PASSWORD'));
					}
				}
				//event.stopImmediatePropagation();
				PopUpManager.removePopUp(chkPass);
				chkPass.removeEventListener(CloseEvent.CLOSE,onWinClose);
			}
			
			protected function panel1_clickHandler(event:MouseEvent):void
			{
				// TODO Auto-generated method stub
				trace( "...........Widget panel is clicked.....................", info.title );
				this.showWindow();
			}
			
		]]>
	</fx:Script>
	<s:Image includeIn="icon" source="{menu_ico}" verticalCenter="0" horizontalCenter="0" maxWidth="128" maxHeight="128" buttonMode="true" width="100%" height="100%" smooth="true" scaleMode="letterbox"/>
	<s:ModuleLoader includeIn="widget"  id="ldr" url="{module}" top="0" left="0" bottom="0" right="0"  ready="moduleloader1_readyHandler(event)"  preinitialize="ldr.applicationDomain=ApplicationDomain.currentDomain"/>
</s:Panel>
